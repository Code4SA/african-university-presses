<html>
<head>
  <link rel="stylesheet" href="cartodb.css" />
  <title>African University Presses</title>
  <script src="cartodb.js"></script>
  <style>
    html, body {width:100%; height:100%; padding: 0; margin: 0;}
    #map { width: 100%; height:100%; background: white;}
    #menu { position: absolute; top: 5px; right: 10px; width: 150px; height:60px; background: transparent; z-index:10;}
    #menu a { 
      margin: 15px 10px 0 0;
      float: right;
      vertical-align: baseline;
      width: 120px;
      padding: 10px;
      text-align: center;
      font: bold 11px "Helvetica",Arial;
      line-height: normal;
      color: #555;
      border-radius: 4px;
      border: 1px solid #777777;
      background: #ffffff;
      text-decoration: none;
      cursor: pointer;
    }
    #menu a.selected,
    #menu a:hover { 
      color: #F84F40;
    }
    #info{
      margin: 15px 10px 0 0;
        font: 15px "Helvetica",Arial;
        color:#000;
        background-color: rgba(255,255,255,.9);
        width:250px;
        height:350px;
        top:5px;
        left:60px;
        border: 1px solid #777777;
        border-radius: 4px;
        position: absolute;
        z-index: 11;
        padding: 10px;
        text-align: left;
        display: table-cell;
        vertical-align: center;
      }
    #info a:link {
	text-decoration:underline;
        color:#000;
	
    }
    #info a:hover {
	text-decoration:none;
    }
    #info a:visited {
	text-decoration:underline;
        color:#000;
    }
  </style>

  <script>
  var map;
    function init(){
  // initiate leaflet map
  map = new L.Map('map', { 
      center: [0,10],
      zoom: 3
  })




  L.tileLayer("http://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png", {
    attribution: '<a href="https://docs.google.com/spreadsheets/d/1URiTsMVkeM12DlZT7IfxqcYgVEt0hohIi4xIy983FI8/edit?ts=56b1b5c7#gid=0" target="_blank">Full dataset, feedback/corrections</a>, <a href="http://code4sa.org/" target="_blank">Code4SA</a>'
  }).addTo(map);

  var layerUrl = 'https://adi45.cartodb.com/api/v2/viz/f394b4a6-ce48-11e5-85e3-0e674067d321/viz.json';

  var sublayers = [];

  cartodb.createLayer(map, layerUrl)
  .addTo(map)
  .on('done', function(layer) {
    // change the query for the first layer
    var subLayerOptions = {
      sql: "SELECT * FROM presses",
      interactivity:"university, university_press, facebook, twitter, url, repository, open_access, most_recent, publication_fees",

    }

    var sublayer = layer.getSubLayer(0);
    sublayer.set(subLayerOptions);

sublayer.on('featureClick', function(e, latlng, pos, data, subLayerIndex) {
  console.log("clicked feature: " + data);
        university=data.university;
	university_press=data.university_press;
	most_recent=data.most_recent;
	facebook_url=data.facebook;
	open_access=data.open_access;
	publication_fees=data.publication_fees;
	repository=data.repository;
	twitter_handle=data.twitter;
	url=data.url;
	info.innerHTML='<p><b>'+university+'</b></p>'+'<hr>'+'<p>'+university_press+'</p>'+'</p>'+'<p>Open access: '+open_access+'</p>'+'<p>Publication fees: '+publication_fees+'</p>'+'<p>Most recent publication: '+most_recent+'<p>Institutional repository: '+repository+'<p>Website: '+url+'</p>'+'<p>Facebook: '+facebook_url+'<p>Twitter: '+twitter_handle+'</p>';

});

    sublayers.push(sublayer);
  }).on('error', function() {
    //log the error
  })

  //we define the queries that will be performed when we click on the buttons, by modifying the SQL of our layer
  var LayerActions = {
    all: function(){
      sublayers[0].setSQL("SELECT * FROM presses");
      return true;
    },
    twitter: function(){
      sublayers[0].setSQL("SELECT * FROM presses WHERE twitter != ''");
      return true;
    },
    facebook: function(){
      sublayers[0].setSQL("SELECT * FROM presses WHERE facebook != ''");
      return true;
    },
    openaccess: function(){
      sublayers[0].setSQL("SELECT * FROM presses WHERE open_access = 'yes'");
      return true;
    },
    url: function(){
      sublayers[0].setSQL("SELECT * FROM presses WHERE url != ''");
      return true;
    },
    publicationfees: function(){
      sublayers[0].setSQL("SELECT * FROM presses WHERE publication_fees = 'no'");
      return true;
    },
    repository: function(){
      sublayers[0].setSQL("SELECT * FROM presses WHERE repository != ''");
      return true;
    }
  }

  $('.button').click(function() {
    $('.button').removeClass('selected');
    $(this).addClass('selected');
    //this gets the id of the different buttons and calls to LayerActions which responds according to the selected id
    LayerActions[$(this).attr('id')]();
  });
}
  </script>
</head>

<body onload="init()">
  <div id='map'></div>
  <div id="info"></div>
  <div id='menu'>
    <a href="#all" id="all" class="button all" title="Show all university presses">ALL</a>
    <a href="#openaccess" id="openaccess" class="button openaccess" title="Show presses with open access">OPEN ACCESS</a> 
    <a href="#publicationfees" id="publicationfees" class="button publicationfees" title="Show presses without publication fees">PUBLICATION FEES</a> 
    <a href="#repository" id="repository" class="button repository" title="Show presses with an institutional repository">INSTITUTIONAL REPOSITORY</a> 
    <a href="#url" id="url" class="button url" title="Show presses with their own website">WEBSITE</a> 
    <a href="#facebook" id="facebook" class="button facebook" title="Show presses with a Facebook page">FACEBOOK</a> 
    <a href="#twitter" id="twitter" class="button twitter" title="Show presses with a Twitter page">TWITTER</a> 
  </div>
</body>
</html>
